<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="smartCrmDAO">


	<select id="selectCrmList" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="java.util.HashMap">
		SELECT TAKESEQ,
			TO_CHAR(RECEIPTDATE, 'YYYY-MM-DD HH24:MI')  RECEIPTDATE,
			AUTONUMBER,
      		CUSTOMER_AUTOKIND,
      		CUSTOMER_NAME,
			CUSTOMER_TEL, 
			REPAIR_ENUM(TAKESEQ) REPAIRCODE_NAME, 
			FN_CODENAME(POSITION, 'AUTO_ROOM') POSITION_NAME,
			A.POSITION,
			ETIME,
			FN_CODENAME(REPAIRMETHOD, 'AUTO_ME') REPAIRMETHOD_NAME,
			A.TASKSTAT,
			FN_CODENAME(TASKSTAT, 'AUTO_PROC') TASKSTAT_NAME,
			TO_CHAR(TURNOVERTIME, 'YYYY-MM-DD HH24:MI')  TURNOVERTIME,
			REPAIRNOTE,
			A.NOTE,
			TURNOVER_NOTE
		FROM   CAR_TAKEREPAIR A, CAR_CUSTOMER B
		WHERE  A.CUSTOMER_ID = B.CUSTOMER_ID
		AND A.TASKSTAT = 'CB-perfect'
		AND A.TURNOVER = 'Y'
        <if test="searchAutoNo != ''">
            AND A.CUSTOMER_AUTONO LIKE '%' ||#{searchAutoNo}|| '%'
        </if>
        <if test="searchCusNm != ''">
            AND A.CUSTOMER_NAME LIKE '%' ||#{searchCusNm}|| '%'
        </if>
        <if test="searchCusTel != ''">
            AND A.CUSTOMER_TEL LIKE '%' ||#{searchCusTel}|| '%'
        </if>
        <if test="(sdate != '' and edate != '')">
        	AND TO_CHAR(RECEIPTDATE, 'YYYY-MM-DD') between #{sdate} and #{edate}
        </if>
        <if test="(sdate == '' and edate != '')">
        	AND TO_CHAR(RECEIPTDATE, 'YYYY-MM-DD') &lt;= #{edate}
        </if>
        <if test="(sdate != '' and edate == '')">
        	AND TO_CHAR(RECEIPTDATE, 'YYYY-MM-DD') &gt;= #{sdate}
        </if>
		<if test="(sdate == '' and edate == '')">
			AND SUBSTR(ETIME,1,10) = TO_CHAR(SYSDATE, 'YYYY-MM-DD')
        </if>
	</select>
   	<select id="selectCrmListTotCnt" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="int">
		
			SELECT 	COUNT(*) totcnt
			FROM 	CAR_CUSTOMER A, CAR_TAKEREPAIR B 
			WHERE 	A.CUSTOMER_ID = B.CUSTOMER_ID
			AND B.TASKSTAT = 'CB-perfect'
			<!-- <if test="searchCondition == &quot;qestnSj&quot;">AND
				C.CUSTOMER_ID, LIKE '%' || #{searchKeyword} || '%'
			</if> -->
	</select>

	<select id="dailyhead" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="java.util.HashMap">
		SELECT 	TO_CHAR(TURNOVERTIME, 'YYYY')||'년 '||TO_CHAR(TURNOVERTIME, 'MM')||'월 '||TO_CHAR(TURNOVERTIME, 'DD')||'일'  turnOverTime
		FROM 	CAR_TAKEREPAIR
		WHERE 	TURNOVER ='Y'
		GROUP BY TO_CHAR(TURNOVERTIME, 'YYYY')||'년 '||TO_CHAR(TURNOVERTIME, 'MM')||'월 '||TO_CHAR(TURNOVERTIME, 'DD')||'일'
		ORDER BY TURNOVERTIME DESC
	</select>
	
    <select id="dailydetail" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="java.util.HashMap">
		SELECT 	FN_LEADTIME_NAME(A.REPAIRCODE, 'NAME') REPAIRCODE_NAME,
	       		COUNT(*) CNT
		FROM 	CAR_LEAD_REPAIR A, CAR_TAKEREPAIR B
		WHERE 	A.TAKESEQ = B.TAKESEQ
		AND 	B.TURNOVER = 'Y' 
		AND 	TO_CHAR(TURNOVERTIME, 'YYYY')||'년 '||TO_CHAR(TURNOVERTIME, 'MM')||'월 '||TO_CHAR(TURNOVERTIME, 'DD')||'일' = #{turnoverTime}
		GROUP BY FN_LEADTIME_NAME(A.REPAIRCODE, 'NAME')
	</select>
	
		<select id="selectLeadTime" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="java.util.HashMap">
		SELECT * FROM CAR_COMCODE WHERE GROUP_CODE = 'LEADTIME'
	</select>
	<select id="selectLeadMain" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="java.util.HashMap">
		SELECT * FROM CAR_LEADTIME WHERE H_CODE = 'STAT'
	</select>
	<select id="selectLeadMiddle" parameterType="egovframework.smart.crm.service.SmartCrmVO" resultType="java.util.HashMap">
		SELECT * FROM CAR_LEADTIME WHERE H_CODE = #{main}
	</select>
	
</mapper>